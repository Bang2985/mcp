parameters:
- name: ServerName
  type: string
  default: ''
- name: PublishTarget
  type: string
  default: none
  values: [none, internal, public ]
- name: RunLiveTests
  type: boolean
  default: false
- name: IncludeNative
  type: boolean
  default: false
- name: PackageDocker
  type: boolean
  default: false
- name: PackageVSIX
  type: boolean
  default: false
- name: IsTestPipeline
  type: boolean
  default: false
  # Test pipelines (e.g. Template.Mcp.Server) can release to public feeds, but they always use prerelease tags and automatically close their version bump PRs
  # This allows us to run them multiple times from the same commit without hitting github release tag or package deployment conflicts

resources:
  repositories:
  - repository: azure-sdk-build-tools
    type: git
    name: internal/azure-sdk-build-tools
    ref: refs/tags/azure-sdk-build-tools_20250808.1

extends:
  template: /eng/pipelines/templates/1es-redirect.yml
  parameters:
    autoBaseline: false
    stages:
    - stage: CheckTokens
      pool:
        name: $(LINUXPOOL)
        image: $(LINUXVMIMAGE)
        os: linux
      variables:
      - template: /eng/pipelines/templates/variables/image.yml
      - template: /eng/pipelines/templates/variables/globals.yml
      jobs:
      - job: CheckTokens
        steps:
        - task: UseDotNet@2
          displayName: "Use .NET SDK from global.json"
          retryCountOnTaskFailure: 3
          inputs:
            useGlobalJson: true

        - task: AzureCLI@2
          displayName: "az account show"
          inputs:
            azureSubscription: azure-sdk-vsmarketplace
            scriptType: pscore
            scriptLocation: inlineScript
            inlineScript: |
              az account show

        - ${{ each i in split('1,2,3', ',') }}:
          - task: AzurePowershell@5
            displayName: "Azure Powershell ${{ i }}"
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
            inputs:
              azureSubscription: azure-sdk-tests-public
              azurePowerShellVersion: 'LatestVersion'
              scriptType: InlineScript
              Inline: |
                $env:AZURE_TOKEN_CREDENTIALS = 'AzurePowerShellCredential'

                Write-Host "`Checking pipeline token..."
                dotnet run --project ./src/TokenDump.csproj -- SYSTEM_ACCESSTOKEN

                Write-Host "`Vault Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://vault.azure.net/.default

                Write-Host "`Graph Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://graph.microsoft.com/.default

                Write-Host "`Storage Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://storage.azure.com/.default

                Write-Host "Waiting 3 minutes..."
                Start-Sleep -Seconds 180

                Write-Host "`Vault Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://vault.azure.net/.default

                Write-Host "`Graph Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://graph.microsoft.com/.default

                Write-Host "`Storage Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://storage.azure.com/.default

                Write-Host "Waiting 3 minutes..."
                Start-Sleep -Seconds 180

                Write-Host "`Vault Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://vault.azure.net/.default

                Write-Host "`Graph Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://graph.microsoft.com/.default

                Write-Host "`Storage Token..."
                dotnet run --project ./src/TokenDump.csproj -- https://storage.azure.com/.default
              pwsh: true
              workingDirectory: $(Build.SourcesDirectory)
